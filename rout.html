<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>OptiFleet - Routes Management</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="Free HTML Templates" name="keywords">
    <meta content="Free HTML Templates" name="description">

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/style.css" rel="stylesheet">
</head>

<body>
    <!-- Topbar Start -->
    <div class="container-fluid bg-dark">
        <div class="row py-2 px-lg-5">
            <div class="col-lg-6 text-center text-lg-left mb-2 mb-lg-0">
                <div class="d-inline-flex align-items-center text-white">
                    <small><i class="fa fa-phone-alt mr-2"></i>+91 9562345678</small>
                    <small class="px-3">|</small>
                    <small><i class="fa fa-envelope mr-2"></i>optifleet@example.com</small>
                </div>
            </div>
            <div class="col-lg-6 text-center text-lg-right">
                <div class="d-inline-flex align-items-center">
                    <a class="text-white px-2" href="">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a class="text-white px-2" href="">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a class="text-white px-2" href="">
                        <i class="fab fa-linkedin-in"></i>
                    </a>
                    <a class="text-white px-2" href="">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a class="text-white pl-2" href="">
                        <i class="fab fa-youtube"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- Topbar End -->


    <!-- Navbar Start -->
    <div class="container-fluid p-0">
        <nav class="navbar navbar-expand-lg bg-light navbar-light py-3 py-lg-0 px-lg-5">
            <a href="index.html" class="navbar-brand ml-lg-3">
                <h1 class="m-0 display-5 text-uppercase text-primary"><i class="fa fa-truck mr-2"></i>OptiFleet</h1>
            </a>
            <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-between px-lg-3" id="navbarCollapse">
                <div class="navbar-nav m-auto py-0">
                    <a href="index.html" class="nav-item nav-link">Home</a>
                    <a href="about.html" class="nav-item nav-link">About</a>
                    <a href="service.html" class="nav-item nav-link">Service</a>
                    <a href="faq.html" class="nav-item nav-link">FAQs</a>
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" id="dashboardDropdown" data-toggle="dropdown">Dashboard</a>
                        <div class="dropdown-menu rounded-0 m-0">
                            <a href="realtime.html" class="dropdown-item">Map view</a>
                            <a href="fleet.html" class="dropdown-item">Fleet routes</a>
                            <a href="routes1.html" class="dropdown-item nav-item nav-link active">Add Vehicles</a>
                        </div>
                    </div>
                    <a href="contact.html" class="nav-item nav-link">Contact</a>
                </div>
                <a href="dashboard.html" class="btn btn-primary py-2 px-4 d-none d-lg-block">Dashboard</a>
            </div>
        </nav>
    </div>
    <!-- Navbar End -->

    <div class="container">
        <h1 class="mt-4 mb-4">Route Management</h1>
        
        <div class="row">
            <div class="col-md-5">
                <!-- Route Information Form -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4>Route Details</h4>
                    </div>
                    <div class="card-body">
                        <form id="routeDetailsForm">
                            <div class="form-group">
                                <label>Route Name</label>
                                <input type="text" id="routeName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Assigned Driver</label>
                                <input type="text" id="driverName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Vehicle Number</label>
                                <input type="text" id="vehicleNumber" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Start Date</label>
                                <input type="date" id="startDate" class="form-control" required>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Form to Add Stops -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4>Add Stops</h4>
                    </div>
                    <div class="card-body">
                        <form id="addStopForm">
                            <div class="form-group">
                                <label>Stop Name</label>
                                <input type="text" id="stopName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Stop Address</label>
                                <input type="text" id="stopAddress" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Time Window</label>
                                <input type="text" id="timeWindow" class="form-control" placeholder="e.g., 9:00 AM - 11:00 AM" required>
                            </div>
                            <button type="submit" class="btn btn-success">Add Stop</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-7">
                <!-- Stops Table -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4>Current Stops</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table table-bordered table-hover">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Stop Name</th>
                                        <th>Stop Address</th>
                                        <th>Time Window</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="stopsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Save Route Button -->
                <div class="text-center mb-4">
                    <button id="saveRouteBtn" class="btn btn-primary btn-lg">Save Complete Route</button>
                </div>
                
                <!-- Preview Map -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4>Route Preview</h4>
                    </div>
                    <div class="card-body">
                        <div id="map" style="width: 100%; height: 300px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    
    <script>
        // Initialize map
        const map = L.map('map').setView([13.0827, 80.2707], 10); // Default: Chennai
        
        // Add OpenStreetMap tiles
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '&copy; OpenStreetMap contributors',
        }).addTo(map);
        
        let currentStops = [];
        let markers = [];
        let routePath = null;
        
        // GraphHopper API Key
        const apiKey = "131b911d-a302-40a0-8a9a-d498fbf68645"; 

        // Function to get coordinates from address
        async function getCoordinates(address) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
                const data = await response.json();
                return data.length > 0 ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
            } catch (error) {
                console.error("Error fetching coordinates:", error);
                // Return a random coordinate near Chennai if geocoding fails (for demo purposes)
                const lat = 13.0827 + (Math.random() - 0.5) * 0.1;
                const lon = 80.2707 + (Math.random() - 0.5) * 0.1;
                return [lat, lon];
            }
        }
        
        // Add Stop Form Handler
$("#addStopForm").submit(async function(e) {
    e.preventDefault();
    
    const stopName = $("#stopName").val();
    const stopAddress = $("#stopAddress").val();
    const timeWindow = $("#timeWindow").val();
    
    // Get coordinates for the address
    const coordinates = await getCoordinates(stopAddress);
    
    if (coordinates) {
        // Add to stops array
        const newStop = {
            name: stopName,
            address: stopAddress,
            timeWindow: timeWindow,
            coordinates: coordinates
        };
        
        currentStops.push(newStop);
        
        // Add marker to map
        const marker = L.marker(coordinates)
            .addTo(map)
            .bindPopup(`<b>${stopName}</b><br>${stopAddress}<br>${timeWindow}`);
        
        markers.push(marker);
        
        // Update the table
        updateStopsTable();
        
        // Update route path if we have at least 2 stops
        if (currentStops.length >= 2) {
            updateRoutePath();
        }
        
        // Fit map to markers
        if (markers.length > 0) {
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        }
        
        // Clear form
        $("#stopName").val("");
        $("#stopAddress").val("");
        $("#timeWindow").val("");
    } else {
        alert("Could not geocode the address. Please try again.");
    }
});

// Function to update the stops table
function updateStopsTable() {
    const tableBody = $("#stopsTableBody");
    tableBody.empty();
    
    currentStops.forEach((stop, index) => {
        tableBody.append(`
            <tr>
                <td>${stop.name}</td>
                <td>${stop.address}</td>
                <td>${stop.timeWindow}</td>
                <td>
                    <button class="btn btn-sm btn-danger delete-stop" data-index="${index}">
                        <i class="fa fa-trash"></i>
                    </button>
                </td>
            </tr>
        `);
    });
    
    // Add delete event handlers
    $(".delete-stop").click(function() {
        const index = $(this).data("index");
        deleteStop(index);
    });
}

// Function to delete a stop
function deleteStop(index) {
    // Remove marker from map
    map.removeLayer(markers[index]);
    markers.splice(index, 1);
    
    // Remove from stops array
    currentStops.splice(index, 1);
    
    // Update table
    updateStopsTable();
    
    // Update route path
    if (currentStops.length >= 2) {
        updateRoutePath();
    } else if (routePath) {
        map.removeLayer(routePath);
        routePath = null;
    }
}

// Function to update route path using GraphHopper API
async function updateRoutePath() {
    // Remove existing path
    if (routePath) {
        map.removeLayer(routePath);
    }
    
    try {
        // Format points for API
        const points = currentStops.map(stop => {
            return {
                "lat": stop.coordinates[0],
                "lng": stop.coordinates[1]
            };
        });
        
        // Build request URL for GraphHopper API
        const url = `https://graphhopper.com/api/1/route?points_encoded=false&key=${apiKey}`;
        
        // Make API request
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                points: points,
                vehicle: "car"
            })
        });
        
        const data = await response.json();
        
        if (data.paths && data.paths.length > 0) {
            // Extract coordinates from response
            const coordinates = data.paths[0].points.coordinates.map(coord => [coord[1], coord[0]]);
            
            // Create polyline
            routePath = L.polyline(coordinates, {
                color: 'blue',
                weight: 4,
                opacity: 0.7
            }).addTo(map);
            
            // Fit map to show entire route
            map.fitBounds(routePath.getBounds().pad(0.1));
        }
    } catch (error) {
        console.error("Error fetching route:", error);
        // Create a simple polyline connecting points for demo purposes
        const simpleCoords = currentStops.map(stop => stop.coordinates);
        routePath = L.polyline(simpleCoords, {
            color: 'red',
            weight: 4,
            opacity: 0.7,
            dashArray: '5, 10'
        }).addTo(map);
    }
}

// Save Route Button Handler
$("#saveRouteBtn").click(function() {
    const routeName = $("#routeName").val();
    const driverName = $("#driverName").val();
    const vehicleNumber = $("#vehicleNumber").val();
    const startDate = $("#startDate").val();
    
    if (!routeName || !driverName || !vehicleNumber || !startDate) {
        alert("Please fill in all route details!");
        return;
    }
    
    if (currentStops.length < 2) {
        alert("Please add at least two stops to create a route!");
        return;
    }
    
    // Create route object
    const route = {
        name: routeName,
        driver: driverName,
        vehicle: vehicleNumber,
        startDate: startDate,
        stops: currentStops
    };
    
    // In a real application, you would save this to a database
    // For demo purposes, we'll just log it and show a success message
    console.log("Saving route:", route);
    
    // Show success message
    alert(`Route "${routeName}" has been saved successfully!`);
    
    // Reset the form
    $("#routeDetailsForm")[0].reset();
    $("#stopsTableBody").empty();
    currentStops = [];
    
    // Clear markers and path
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];
    
    if (routePath) {
        map.removeLayer(routePath);
        routePath = null;
    }
});
    </script>

    <!-- Footer Start -->
    <div class="container-fluid bg-dark text-white mt-5 py-5 px-sm-3 px-md-5">
        <div class="row pt-5">
            <div class="col-lg-7 col-md-6">
                <div class="row">
                    <div class="col-md-6 mb-5">
                        <h3 class="text-primary mb-4">Get In Touch</h3>
                        <p><i class="fa fa-map-marker-alt mr-2"></i>123 Street, Chennai, India</p>
                        <p><i class="fa fa-phone-alt mr-2"></i>+91 9562345678</p>
                        <p><i class="fa fa-envelope mr-2"></i>optifleet@example.com</p>
                        <div class="d-flex justify-content-start mt-4">
                            <a class="btn btn-outline-light btn-social mr-2" href="#"><i class="fab fa-twitter"></i></a>
                            <a class="btn btn-outline-light btn-social mr-2" href="#"><i class="fab fa-facebook-f"></i></a>
                            <a class="btn btn-outline-light btn-social mr-2" href="#"><i class="fab fa-linkedin-in"></i></a>
                            <a class="btn btn-outline-light btn-social" href="#"><i class="fab fa-instagram"></i></a>
                        </div>
                    </div>
                    <div class="col-md-6 mb-5">
                        <h3 class="text-primary mb-4">Quick Links</h3>
                        <div class="d-flex flex-column justify-content-start">
                            <a class="text-white mb-2" href="#"><i class="fa fa-angle-right mr-2"></i>Home</a>
                            <a class="text-white mb-2" href="#"><i class="fa fa-angle-right mr-2"></i>About Us</a>
                            <a class="text-white mb-2" href="#"><i class="fa fa-angle-right mr-2"></i>Our Services</a>
                            <a class="text-white mb-2" href="#"><i class="fa fa-angle-right mr-2"></i>Pricing Plan</a>
                            <a class="text-white" href="#"><i class="fa fa-angle-right mr-2"></i>Contact Us</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5 col-md-6 mb-5">
                <h3 class="text-primary mb-4">Newsletter</h3>
                <p>Stay updated with our latest features and announcements</p>
                <div class="w-100">
                    <div class="input-group">
                        <input type="text" class="form-control border-light" style="padding: 30px;" placeholder="Your Email Address">
                        <div class="input-group-append">
                            <button class="btn btn-primary px-4">Sign Up</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid bg-dark text-white border-top py-4 px-sm-3 px-md-5" style="border-color: rgba(256, 256, 256, .1) !important;">
        <div class="row">
            <div class="col-lg-6 text-center text-md-left mb-3 mb-md-0">
                <p class="m-0 text-white">&copy; <a href="#">OptiFleet</a>. All Rights Reserved.</p>
            </div>
            <div class="col-lg-6 text-center text-md-right">
                <ul class="nav d-inline-flex">
                    <li class="nav-item">
                        <a class="nav-link text-white py-0" href="#">Privacy</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white py-0" href="#">Terms</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white py-0" href="#">FAQs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white py-0" href="#">Help</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <!-- Footer End -->

    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary back-to-top"><i class="fa fa-angle-double-up"></i></a>

    <!-- JavaScript Libraries -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/counterup/counterup.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>
</body>

</html>