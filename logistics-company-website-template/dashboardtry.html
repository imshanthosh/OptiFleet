<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>OptiFleet - Dashboard</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="Free HTML Templates" name="keywords">
    <meta content="Free HTML Templates" name="description">

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/style.css" rel="stylesheet">
</head>

<body>
    <!-- Topbar Start -->
    <div class="container-fluid bg-dark">
        <div class="row py-2 px-lg-5">
            <div class="col-lg-6 text-center text-lg-left mb-2 mb-lg-0">
                <div class="d-inline-flex align-items-center text-white">
                    <small><i class="fa fa-phone-alt mr-2"></i>+91 9562345678</small>
                    <small class="px-3">|</small>
                    <small><i class="fa fa-envelope mr-2"></i>optifleet@example.com</small>
                </div>
            </div>
            <div class="col-lg-6 text-center text-lg-right">
                <div class="d-inline-flex align-items-center">
                    <a class="text-white px-2" href="">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a class="text-white px-2" href="">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a class="text-white px-2" href="">
                        <i class="fab fa-linkedin-in"></i>
                    </a>
                    <a class="text-white px-2" href="">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a class="text-white pl-2" href="">
                        <i class="fab fa-youtube"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- Topbar End -->

    <!-- Navbar Start -->
    <div class="container-fluid p-0">
        <nav class="navbar navbar-expand-lg bg-light navbar-light py-3 py-lg-0 px-lg-5">
            <a href="index.html" class="navbar-brand ml-lg-3">
                <h1 class="m-0 display-5 text-uppercase text-primary"><i class="fa fa-truck mr-2"></i>OptiFleet</h1>
            </a>
            <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-between px-lg-3" id="navbarCollapse">
                <div class="navbar-nav m-auto py-0">
                    <a href="index.html" class="nav-item nav-link">Home</a>
                    <a href="about.html" class="nav-item nav-link">About</a>
                    <a href="service.html" class="nav-item nav-link">Service</a>
                    <a href="faq.html" class="nav-item nav-link">FAQs</a>
                    <div class="nav-item dropdown">
                        <a href="dashboard.html" class="nav-link dropdown-toggle active" id="dashboardDropdown" data-toggle="dropdown">Dashboard</a>
                        <div class="dropdown-menu rounded-0 m-0">
                            <a href="realtime.html" class="dropdown-item">Map view</a>
                            <a href="fleet.html" class="dropdown-item">Fleet routes</a>
                            <a href="routestry.html" class="dropdown-item">Add Vehicles</a>
                        </div>
                    </div>
                    <a href="contact.html" class="nav-item nav-link">Contact</a>
                </div>
                <a href="realtime.html" class="btn btn-primary py-2 px-4 d-none d-lg-block">Map View</a>
            </div>
        </nav>
    </div>
    <!-- Navbar End -->

    <div class="container mt-4">
        <h1 class="mb-4">Dashboard</h1>
        
        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4>Fleet Overview Map</h4>
                    </div>
                    <div class="card-body">
                        <div id="overviewMap" style="width: 100%; height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <h2 class="mb-3">Active Routes</h2>
        <div class="row" id="routesContainer">
            <!-- Routes will be dynamically inserted here -->
            <div class="col-12 text-center py-5" id="loadingRoutes">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <p class="mt-2">Loading routes...</p>
            </div>
        </div>
    </div>

    <!-- Footer Start -->
    <div class="container-fluid bg-dark text-white mt-5 py-5 px-sm-3 px-md-5">
        <div class="row pt-5">
            <div class="col-lg-7 col-md-6">
                <div class="row">
                    <div class="col-md-6 mb-5">
                        <h3 class="text-primary mb-4">Get In Touch</h3>
                        <p><i class="fa fa-map-marker-alt mr-2"></i>Chennai,India</p>
                        <p><i class="fa fa-phone-alt mr-2"></i>+91 9562345678 </p>
                        <p><i class="fa fa-envelope mr-2"></i>optifleet@example.com</p>
                        <div class="d-flex justify-content-start mt-4">
                            <a class="btn btn-outline-light btn-social mr-2" href="#"><i class="fab fa-twitter"></i></a>
                            <a class="btn btn-outline-light btn-social mr-2" href="#"><i class="fab fa-facebook-f"></i></a>
                            <a class="btn btn-outline-light btn-social mr-2" href="#"><i class="fab fa-linkedin-in"></i></a>
                            <a class="btn btn-outline-light btn-social" href="#"><i class="fab fa-instagram"></i></a>
                        </div>
                    </div>
                    <div class="col-md-6 mb-5">
                        <h3 class="text-primary mb-4">Quick Links</h3>
                        <div class="d-flex flex-column justify-content-start">
                            <a class="text-white mb-2" href="#"><i class="fa fa-angle-right mr-2"></i>Home</a>
                            <a class="text-white mb-2" href="#"><i class="fa fa-angle-right mr-2"></i>About Us</a>
                            <a class="text-white mb-2" href="#"><i class="fa fa-angle-right mr-2"></i>Our Services</a>
                            <a class="text-white mb-2" href="#"><i class="fa fa-angle-right mr-2"></i>Pricing Plan</a>
                            <a class="text-white" href="#"><i class="fa fa-angle-right mr-2"></i>Contact Us</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5 col-md-6 mb-5">
                <h3 class="text-primary mb-4">Newsletter</h3>
                <p>Rebum labore lorem dolores kasd est, et ipsum amet et at kasd, ipsum sea tempor magna tempor. Accu kasd sed ea duo ipsum. Dolor duo eirmod sea justo no lorem est diam</p>
                <div class="w-100">
                    <div class="input-group">
                        <input type="text" class="form-control border-light" style="padding: 30px;" placeholder="Your Email Address">
                        <div class="input-group-append">
                            <button class="btn btn-primary px-4">Sign Up</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid bg-dark text-white border-top py-4 px-sm-3 px-md-5" style="border-color: #3E3E4E !important;">
        <div class="row">
            <div class="col-lg-6 text-center text-md-left mb-3 mb-md-0">
                <p class="m-0 text-white">&copy; <a href="#">OPTIFLEET</a>. All Rights Reserved.</p>
            </div>
            <div class="col-lg-6 text-center text-md-right">
                <ul class="nav d-inline-flex">
                    <li class="nav-item">
                        <a class="nav-link text-white py-0" href="#">Privacy</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white py-0" href="#">Terms</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white py-0" href="#">FAQs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white py-0" href="#">Help</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <!-- Footer End -->

    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary back-to-top"><i class="fa fa-angle-double-up"></i></a>

    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/counterup/counterup.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>

    <!-- Contact Javascript File -->
    <script src="mail/jqBootstrapValidation.min.js"></script>
    <script src="mail/contact.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>

    <!-- Firebase and Dashboard Script -->
    <script type="module">
        import { db, collection, getDocs, doc } from "./firebaseConfig.js";

        // Initialize overview map
        const overviewMap = L.map('overviewMap').setView([13.0827, 80.2707], 10); // Default: Chennai
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '&copy; OpenStreetMap contributors',
        }).addTo(overviewMap);
        
        // Store all routes data
        let allRoutes = [];
        // Store route paths and markers for the overview map
        let overviewRouteMarkers = [];
        let overviewRoutePaths = [];
        
        // Generate random pastel colors for different routes
        function getRouteColor(index) {
            const colors = [
                "#FF6B6B", "#4ECDC4", "#FFD166", "#06D6A0", "#118AB2", 
                "#073B4C", "#8338EC", "#3A86FF", "#FB5607", "#FFBE0B"
            ];
            return colors[index % colors.length];
        }
        
        async function fetchRoutes() {
            try {
                const routesContainer = document.getElementById("routesContainer");
                routesContainer.innerHTML = ""; // Clear existing content
                
                const querySnapshot = await getDocs(collection(db, "routes"));
                
                if (querySnapshot.empty) {
                    routesContainer.innerHTML = `
                        <div class="col-12 text-center py-5">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle mr-2"></i>
                                No routes found. Please add routes using the "Add Vehicles" page.
                            </div>
                        </div>
                    `;
                    return;
                }
                
                let routeIndex = 0;
                
                querySnapshot.forEach((doc) => {
                    const route = doc.data();
                    route.id = doc.id;
                    allRoutes.push(route);
                    
                    const routeBox = document.createElement("div");
                    routeBox.className = "col-md-4 mb-4";
                    
                    // Format date for display
                    const formattedDate = new Date(route.startDate).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                    
                    // Count total stops
                    const totalStops = route.stops ? route.stops.length : 0;
                    
                    // Get random color for this route
                    const routeColor = getRouteColor(routeIndex);
                    
                    routeBox.innerHTML = `
                        <div class="card h-100">
                            <div class="card-header" style="background-color: ${routeColor}; color: white;">
                                <h5 class="card-title mb-0">${route.routeName}</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="small text-muted mb-2">Driver</div>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-user-circle mr-2" style="font-size: 1.5rem;"></i>
                                        <div>${route.driverName}</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="small text-muted mb-2">Vehicle</div>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-truck mr-2"></i>
                                        <div>${route.vehicleNumber}</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="small text-muted mb-2">Start Date</div>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-calendar-alt mr-2"></i>
                                        <div>${formattedDate}</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="small text-muted mb-2">Total Stops</div>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-map-marker-alt mr-2"></i>
                                        <div>${totalStops} locations</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer d-flex justify-content-between">
                                <button class="btn btn-sm btn-outline-primary view-route-btn" data-route-id="${doc.id}">
                                    <i class="fas fa-eye mr-1"></i> View Details
                                </button>
                                <a href="realtime.html?routeId=${doc.id}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-map-marked-alt mr-1"></i> Track on Map
                                </a>
                            </div>
                        </div>
                    `;
                    
                    routesContainer.appendChild(routeBox);
                    
                    // Add this route to the overview map
                    addRouteToOverviewMap(route, routeColor, routeIndex);
                    
                    routeIndex++;
                });
                
                // Add event listeners for view details buttons
                document.querySelectorAll('.view-route-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const routeId = this.getAttribute('data-route-id');
                        showRouteDetails(routeId);
                    });
                });
                
                // Fit overview map to show all routes
                if (overviewRouteMarkers.length > 0) {
                    const group = new L.featureGroup([...overviewRouteMarkers]);
                    overviewMap.fitBounds(group.getBounds().pad(0.1));
                }
                
            } catch (error) {
                console.error("Error fetching routes:", error);
                const routesContainer = document.getElementById("routesContainer");
                routesContainer.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            Error loading routes: ${error.message}
                        </div>
                    </div>
                `;
            } finally {
                // Hide loading indicator
                document.getElementById("loadingRoutes").style.display = "none";
            }
        }
        
        // Function to add route to overview map
        function addRouteToOverviewMap(route, color, index) {
            if (!route.stops || route.stops.length < 2) return;
            
            const stopMarkers = [];
            
            // Add markers for each stop
            route.stops.forEach((stop, stopIndex) => {
                if (!stop.coords) return;
                
                const isStart = stopIndex === 0;
                const isEnd = stopIndex === route.stops.length - 1;
                
                const markerIcon = isStart ? "green-dot.png" : 
                                  isEnd ? "red-dot.png" : 
                                  "yellow-dot.png";
                
                const marker = L.marker([stop.coords[0], stop.coords[1]], {
                    icon: L.icon({
                        iconUrl: `https://maps.google.com/mapfiles/ms/icons/${markerIcon}`,
                        iconSize: [30, 30]
                    })
                }).addTo(overviewMap);
                
                marker.bindPopup(`
                    <strong>${route.routeName}</strong><br>
                    Stop: ${stop.stopName}<br>
                    ${stop.stopAddress}<br>
                    Time: ${stop.timeWindow}
                `);
                
                stopMarkers.push(marker);
                overviewRouteMarkers.push(marker);
            });
            
            // Create a path between stops
            const coordinates = route.stops
                .filter(stop => stop.coords)
                .map(stop => [stop.coords[0], stop.coords[1]]);
            
            if (coordinates.length >= 2) {
                const routePath = L.polyline(coordinates, {
                    color: color,
                    weight: 5,
                    opacity: 0.7
                }).addTo(overviewMap);
                
                routePath.bindPopup(`<strong>${route.routeName}</strong><br>Driver: ${route.driverName}`);
                overviewRoutePaths.push(routePath);
            }
        }
        
        // Function to show route details in a modal
        function showRouteDetails(routeId) {
            const route = allRoutes.find(r => r.id === routeId);
            if (!route) return;
            
            // Check if modal exists, if not create it
            let modal = document.getElementById('routeDetailsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'routeDetailsModal';
                modal.className = 'modal fade';
                modal.setAttribute('tabindex', '-1');
                modal.setAttribute('role', 'dialog');
                modal.setAttribute('aria-labelledby', 'routeDetailsModalLabel');
                modal.setAttribute('aria-hidden', 'true');
                
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="routeDetailsModalLabel">Route Details</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div id="routeDetailsContent"></div>
                                <div id="routeDetailsMap" style="width: 100%; height: 300px; margin-top: 20px;"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                <a id="viewRouteOnMapBtn" href="#" class="btn btn-primary">Track on Map</a>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            // Set the route content
            const content = document.getElementById('routeDetailsContent');
            const viewRouteOnMapBtn = document.getElementById('viewRouteOnMapBtn');
            
            // Format date
            const formattedDate = new Date(route.startDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            // Create stops HTML
            let stopsHtml = '';
            if (route.stops && route.stops.length > 0) {
                stopsHtml = `
                    <div class="table-responsive mt-3">
                        <table class="table table-bordered table-hover">
                            <thead class="thead-light">
                                <tr>
                                    <th>#</th>
                                    <th>Stop Name</th>
                                    <th>Address</th>
                                    <th>Time Window</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                route.stops.forEach((stop, index) => {
                    stopsHtml += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${stop.stopName}</td>
                            <td>${stop.stopAddress}</td>
                            <td>${stop.timeWindow}</td>
                        </tr>
                    `;
                });
                
                stopsHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                stopsHtml = '<p class="alert alert-warning">No stops defined for this route.</p>';
            }
            
            content.innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h4>${route.routeName}</h4>
                        <p><strong>Driver:</strong> ${route.driverName}</p>
                        <p><strong>Vehicle:</strong> ${route.vehicleNumber}</p>
                        <p><strong>Start Date:</strong> ${formattedDate}</p>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title">Route Summary</h5>
                                <p><strong>Total Stops:</strong> ${route.stops ? route.stops.length : 0}</p>
                                <p><strong>Created:</strong> ${new Date(route.createdAt).toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h5>Stops</h5>
                ${stopsHtml}
            `;
            
            // Update link to view on map
            viewRouteOnMapBtn.href = `realtime.html?routeId=${routeId}`;
            
            // Initialize the map when modal is shown
            $(modal).on('shown.bs.modal', function () {
                const routeDetailsMap = L.map('routeDetailsMap').setView([13.0827, 80.2707], 10);
                
                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    attribution: '&copy; OpenStreetMap contributors',
                }).addTo(routeDetailsMap);
                
                if (route.stops && route.stops.length > 0) {
                    const markers = [];
                    
                    // Add markers for each stop
                    route.stops.forEach((stop, index) => {
                        if (!stop.coords) return;
                        
                        const isStart = index === 0;
                        const isEnd = index === route.stops.length - 1;
                        
                        const markerIcon = isStart ? "green-dot.png" : 
                                          isEnd ? "red-dot.png" : 
                                          "yellow-dot.png";
                        
                        const marker = L.marker([stop.coords[0], stop.coords[1]], {
                            icon: L.icon({
                                iconUrl: `https://maps.google.com/mapfiles/ms/icons/${markerIcon}`,
                                iconSize: [30, 30]
                            })
                        }).addTo(routeDetailsMap);
                        
                        marker.bindPopup(`
                            <strong>Stop ${index + 1}: ${stop.stopName}</strong><br>
                            ${stop.stopAddress}<br>
                            Time: ${stop.timeWindow}
                        `);
                        
                        markers.push(marker);
                    });
                    
                    // Draw route path
                    const coordinates = route.stops
                        .filter(stop => stop.coords)
                        .map(stop => [stop.coords[0], stop.coords[1]]);
                    
                    if (coordinates.length >= 2) {
                        const routePath = L.polyline(coordinates, {
                            color: getRouteColor(0),
                            weight: 5,
                            opacity: 0.7
                        }).addTo(routeDetailsMap);
                    }
                    
                    // Fit map to show all markers
                    if (markers.length > 0) {
                        const group = new L.featureGroup(markers);
                        routeDetailsMap.fitBounds(group.getBounds().pad(0.1));
                    }
                }
            });
            
            // Clear map when modal is hidden
            $(modal).on('hidden.bs.modal', function () {
                // This ensures we don't have map rendering issues when reopening
                const mapContainer = document.getElementById('routeDetailsMap');
                mapContainer.innerHTML = '';
            });
            
            // Show the modal
            $(modal).modal('show');
        }
        
        // Initialize and fetch routes
        fetchRoutes();
    </script>
</body>

</html>