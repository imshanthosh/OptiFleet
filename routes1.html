<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>OptiFleet - Routes Management</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="Free HTML Templates" name="keywords">
    <meta content="Free HTML Templates" name="description">

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/style.css" rel="stylesheet">
</head>

<body>
    <!-- Topbar Start -->
    <div class="container-fluid bg-dark">
        <div class="row py-2 px-lg-5">
            <div class="col-lg-6 text-center text-lg-left mb-2 mb-lg-0">
                <div class="d-inline-flex align-items-center text-white">
                    <small><i class="fa fa-phone-alt mr-2"></i>+91 9562345678</small>
                    <small class="px-3">|</small>
                    <small><i class="fa fa-envelope mr-2"></i>optifleet@example.com</small>
                </div>
            </div>
            <div class="col-lg-6 text-center text-lg-right">
                <div class="d-inline-flex align-items-center">
                    <a class="text-white px-2" href="">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a class="text-white px-2" href="">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a class="text-white px-2" href="">
                        <i class="fab fa-linkedin-in"></i>
                    </a>
                    <a class="text-white px-2" href="">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a class="text-white pl-2" href="">
                        <i class="fab fa-youtube"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- Topbar End -->


    <!-- Navbar Start -->
    <div class="container-fluid p-0">
        <nav class="navbar navbar-expand-lg bg-light navbar-light py-3 py-lg-0 px-lg-5">
            <a href="index.html" class="navbar-brand ml-lg-3">
                <h1 class="m-0 display-5 text-uppercase text-primary"><i class="fa fa-truck mr-2"></i>OptiFleet</h1>
            </a>
            <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-between px-lg-3" id="navbarCollapse">
                <div class="navbar-nav m-auto py-0">
                    <a href="index.html" class="nav-item nav-link">Home</a>
                    <a href="about.html" class="nav-item nav-link">About</a>
                    <a href="service.html" class="nav-item nav-link">Service</a>
                    <a href="faq.html" class="nav-item nav-link">FAQs</a>
                    <div class="nav-item dropdown">
                        <a href="dashboard.html" class="nav-link dropdown-toggle" id="dashboardDropdown" data-toggle="dropdown">Dashboard</a>
                        <div class="dropdown-menu rounded-0 m-0">
                            <a href="realtime.html" class="dropdown-item">Map view</a>
                            <a href="fleet.html" class="dropdown-item">Fleet routes</a>
                            <a href="routes1.html" class="dropdown-item nav-item nav-link active">Add Vehicles</a>
                        </div>
                    </div>
                    <a href="contact.html" class="nav-item nav-link">Contact</a>
                </div>
                <a href="realtime.html" class="btn btn-primary py-2 px-4 d-none d-lg-block">Map View</a>
            </div>
        </nav>
    </div>
    <!-- Navbar End -->

    <div class="container">
        <h1 class="mt-4 mb-4">Route Management</h1>
        
        <div class="row">
            <div class="col-md-5">
                <!-- Route Information Form -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4>Route Details</h4>
                    </div>
                    <div class="card-body">
                        <form id="routeDetailsForm">
                            <div class="form-group">
                                <label>Route Name</label>
                                <input type="text" id="routeName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Assigned Driver</label>
                                <input type="text" id="driverName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Vehicle Number</label>
                                <input type="text" id="vehicleNumber" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Start Date</label>
                                <input type="date" id="startDate" class="form-control" required>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Form to Add Stops -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4>Add Stops</h4>
                    </div>
                    <div class="card-body">
                        <form id="addStopForm">
                            <div class="form-group">
                                <label>Stop Name</label>
                                <input type="text" id="stopName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Stop Address</label>
                                <input type="text" id="stopAddress" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Time Window</label>
                                <input type="text" id="timeWindow" class="form-control" placeholder="e.g., 9:00 AM - 11:00 AM" required>
                            </div>
                            <button type="submit" class="btn btn-success">Add Stop</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-7">
                <!-- Stops Table -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4>Current Stops</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table table-bordered table-hover">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Stop Name</th>
                                        <th>Stop Address</th>
                                        <th>Time Window</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="stopsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Save Route Button -->
                <div class="text-center mb-4">
                    <button id="saveRouteBtn" class="btn btn-primary btn-lg">Save Complete Route</button>
                </div>
                
                <!-- Preview Map -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4>Route Preview</h4>
                    </div>
                    <div class="card-body">
                        <div id="map" style="width: 100%; height: 300px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    
    <script type="module">
        import { db, collection, addDoc, getDocs, deleteDoc, doc } from "./firebaseConfig.js";

        // Initialize map
        const map = L.map('map').setView([13.0827, 80.2707], 10); // Default: Chennai
        
        // Add OpenStreetMap tiles
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '&copy; OpenStreetMap contributors',
        }).addTo(map);
        
        let currentStops = [];
        let markers = [];
        let routePath = null;
        
        // GraphHopper API Key
        const apiKey = "131b911d-a302-40a0-8a9a-d498fbf68645"; 

        // Function to get coordinates from address
        async function getCoordinates(address) {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
            const data = await response.json();
            return data.length > 0 ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
        }
        
        // Add Stop Form Handler
        $("#addStopForm").submit(async function (event) {
            event.preventDefault();
            const stopName = $("#stopName").val().trim();
            const stopAddress = $("#stopAddress").val().trim();
            const timeWindow = $("#timeWindow").val().trim();
        
            if (!stopName || !stopAddress || !timeWindow) {
                alert("‚ö†Ô∏è Please fill in all fields!");
                return;
            }
            
            try {
                // Get coordinates for the address
                const coords = await getCoordinates(stopAddress);
                if (!coords) {
                    alert("‚ö†Ô∏è Could not find coordinates for this address!");
                    return;
                }
                
                // Add stop to current stops array
                const newStop = { stopName, stopAddress, timeWindow, coords };
                currentStops.push(newStop);
                
                // Update table and map
                refreshStopsTable();
                addStopToMap(newStop);
                updateRouteOnMap();
                
                // Reset form
                $("#addStopForm")[0].reset();
            } catch (error) {
                console.error("üî• Error adding stop:", error);
                alert("‚ùå Failed to add stop. Check the console for details.");
            }
        });
        
        // Remove stop 
        function removeStop(index) {
            currentStops.splice(index, 1);
            refreshStopsTable();
            refreshMap();
        }
        window.removeStop = removeStop;
        
        // Refresh stops table
        function refreshStopsTable() {
            const tbody = $("#stopsTableBody");
            tbody.empty();
            
            currentStops.forEach((stop, index) => {
                const row = `<tr>
                           <td>${stop.stopName}</td>
                           <td>${stop.stopAddress}</td>
                           <td>${stop.timeWindow}</td>
                           <td>
                               <button class="btn btn-sm btn-danger" onclick="removeStop(${index})">
                                   <i class="fa fa-trash"></i> Remove
                               </button>
                           </td>
                       </tr>`;
                tbody.append(row);
            });
        }
        
        // Add stop marker to map
        function addStopToMap(stop) {
            const markerIcon = currentStops.length === 1 ? "green-dot.png" : 
                               currentStops.length === currentStops.length ? "red-dot.png" : 
                               "yellow-dot.png";
            
            const marker = L.marker([stop.coords[0], stop.coords[1]], {
                icon: L.icon({
                    iconUrl: `https://maps.google.com/mapfiles/ms/icons/${markerIcon}`,
                    iconSize: [30, 30]
                })
            }).addTo(map).bindPopup(`<strong>${stop.stopName}</strong><br>${stop.stopAddress}`);
            
            markers.push(marker);
            
            // Fit map to show all markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        // Refresh map with all markers
        function refreshMap() {
            // Clear all markers and path
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            if (routePath) {
                map.removeLayer(routePath);
                routePath = null;
            }
            
            // Add markers for all stops
            currentStops.forEach((stop, index) => {
                const markerIcon = index === 0 ? "green-dot.png" : 
                                  index === currentStops.length - 1 ? "red-dot.png" : 
                                  "yellow-dot.png";
                
                const marker = L.marker([stop.coords[0], stop.coords[1]], {
                    icon: L.icon({
                        iconUrl: `https://maps.google.com/mapfiles/ms/icons/${markerIcon}`,
                        iconSize: [30, 30]
                    })
                }).addTo(map).bindPopup(`<strong>${stop.stopName}</strong><br>${stop.stopAddress}`);
                
                markers.push(marker);
            });
            
            // Update route
            updateRouteOnMap();
            
            // Fit map to show all markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        // Update route line on map
        async function updateRouteOnMap() {
            if (currentStops.length < 2) return;
            
            if (routePath) {
                map.removeLayer(routePath);
                routePath = null;
            }
            
            try {
                // Request optimized route from GraphHopper
                const points = currentStops.map(stop => [stop.coords[1], stop.coords[0]]); // Convert to [lon, lat]

                const requestBody = {
                    points,
                    profile: "car",
                    locale: "en",
                    instructions: false,
                    calc_points: true,
                    points_encoded: false
                };

                const response = await fetch(`https://graphhopper.com/api/1/route?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(requestBody),
                });

                const routeData = await response.json();
                if (!routeData.paths || routeData.paths.length === 0) {
                    console.error("‚ö†Ô∏è No route found.");
                    return;
                }

                const route = routeData.paths[0];
                // Draw the optimized route on the map
                routePath = L.polyline(route.points.coordinates.map(coord => [coord[1], coord[0]]), { 
                    color: "blue", 
                    weight: 5 
                }).addTo(map);
                
            } catch (error) {
                console.error("üî• Error fetching route: ", error);
            }
        }
        
        // Save Complete Route
        $("#saveRouteBtn").click(async function() {
            const routeName = $("#routeName").val().trim();
            const driverName = $("#driverName").val().trim();
            const vehicleNumber = $("#vehicleNumber").val().trim();
            const startDate = $("#startDate").val();
            
            if (!routeName || !driverName || !vehicleNumber || !startDate) {
                alert("‚ö†Ô∏è Please fill in all route details!");
                return;
            }
            
            if (currentStops.length < 2) {
                alert("‚ö†Ô∏è Please add at least 2 stops to create a route!");
                return;
            }
            
            try {
                // Save complete route with all stops to Firebase
                const routeData = {
                    routeName,
                    driverName,
                    vehicleNumber,
                    startDate,
                    createdAt: new Date().toISOString(),
                    stops: currentStops
                };
                
                await addDoc(collection(db, "routes"), routeData);
                
                alert("‚úÖ Route saved successfully!");
                
                // Reset the form and stops
                $("#routeDetailsForm")[0].reset();
                currentStops = [];
                refreshStopsTable();
                refreshMap();
                
            } catch (error) {
                console.error("üî• Error saving route: ", error);
                alert("‚ùå Failed to save route. Check the console for details.");
            }
        });
    </script>

    <!-- Footer Start -->
    <div class="container-fluid bg-dark text-white mt-5 py-5 px-sm-3 px-md-5">
        <div class="row pt-5">
            <div class="col-lg-7 col-md-6">
                <div class="row">
                    <div class="col-md-6 mb-5">
                        <h3 class="text-primary mb-4">Get In Touch</h3>
                        <p><i class="fa fa-map-marker-alt mr-2"></i>Chennai,India</p>
                        <p><i class="fa fa-phone-alt mr-2"></i>+91 9562345678 </p>
                        <p><i class="fa fa-envelope mr-2"></i>optifleet@example.com</p>
                        <div class="d-flex justify-content-start mt-4">
                            <a class="btn btn-outline-light btn-social mr-2" href="#"><i class="fab fa-twitter"></i></a>
                            <a class="btn btn-outline-light btn-social mr-2" href="#"><i class="fab fa-facebook-f"></i></a>
                            <a class="btn btn-outline-light btn-social mr-2" href="#"><i class="fab fa-linkedin-in"></i></a>
                            <a class="btn btn-outline-light btn-social" href="#"><i class="fab fa-instagram"></i></a>
                        </div>
                    </div>
                    <div class="col-md-6 mb-5">
                        <h3 class="text-primary mb-4">Quick Links</h3>
                        <div class="d-flex flex-column justify-content-start">
                            <a class="text-white mb-2" href="#"><i class="fa fa-angle-right mr-2"></i>Home</a>
                            <a class="text-white mb-2" href="#"><i class="fa fa-angle-right mr-2"></i>About Us</a>
                            <a class="text-white mb-2" href="#"><i class="fa fa-angle-right mr-2"></i>Our Services</a>
                            <a class="text-white mb-2" href="#"><i class="fa fa-angle-right mr-2"></i>Pricing Plan</a>
                            <a class="text-white" href="#"><i class="fa fa-angle-right mr-2"></i>Contact Us</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5 col-md-6 mb-5">
                <h3 class="text-primary mb-4">Newsletter</h3>
                <p>Rebum labore lorem dolores kasd est, et ipsum amet et at kasd, ipsum sea tempor magna tempor. Accu kasd sed ea duo ipsum. Dolor duo eirmod sea justo no lorem est diam</p>
                <div class="w-100">
                    <div class="input-group">
                        <input type="text" class="form-control border-light" style="padding: 30px;" placeholder="Your Email Address">
                        <div class="input-group-append">
                            <button class="btn btn-primary px-4">Sign Up</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid bg-dark text-white border-top py-4 px-sm-3 px-md-5" style="border-color: #3E3E4E !important;">
        <div class="row">
            <div class="col-lg-6 text-center text-md-left mb-3 mb-md-0">
                <p class="m-0 text-white">&copy; <a href="#">OPTIFLEET</a>. All Rights Reserved.</p>
            </div>
            <div class="col-lg-6 text-center text-md-right">
                <ul class="nav d-inline-flex">
                    <li class="nav-item">
                        <a class="nav-link text-white py-0" href="#">Privacy</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white py-0" href="#">Terms</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white py-0" href="#">FAQs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white py-0" href="#">Help</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <!-- Footer End -->

    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary back-to-top"><i class="fa fa-angle-double-up"></i></a>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/counterup/counterup.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>

    <!-- Contact Javascript File -->
    <script src="mail/jqBootstrapValidation.min.js"></script>
    <script src="mail/contact.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>
</body>

</html>